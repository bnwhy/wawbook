Tu développes un moteur de composition d’images en Node.js utilisant Chromium headless (Puppeteer/Playwright).

Les fichiers EPUB sont uniquement une source de contenu (HTML/CSS/fonts).
Le moteur génère ensuite des images ou PDF via Chromium.

Problème à résoudre

Les EPUB peuvent contenir des polices intégrées via @font-face avec des data URIs base64.

Chromium headless gère mal les polices chargées via base64 :

fallback silencieux

rendu incorrect

polices non intégrées dans les images/PDF

Objectif :
Normaliser toutes les polices issues des EPUB en fichiers .ttf réels servis comme assets web.

Ce que tu dois implémenter
1️⃣ Pipeline fonts (source EPUB)

Parser les CSS extraits des EPUB

Détecter les règles @font-face dont src contient une police en base64 :

src: data:font/ttf;base64,...


Extraire la police

Décoder le base64

Sauvegarder chaque police dans :

/assets/books/{bookId}/fonts/


Supporter :

.ttf

.otf

plusieurs variantes (font-weight, font-style)

2️⃣ Réécriture CSS pour Chromium

Réécrire les règles @font-face pour pointer vers un fichier réel :

@font-face {
  font-family: 'Chiller';
  src: url('/assets/books/{bookId}/fonts/Chiller.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}


Supprimer toute référence base64

Garantir que le CSS final est compatible Chromium headless

3️⃣ Assets pour moteur de rendu

Vérifier que /assets est servi comme assets statiques web

Les URLs doivent être accessibles depuis Chromium

Pas de dépendance aux polices système

4️⃣ Intégration moteur Chromium

Le moteur de rendu :

attend document.fonts.ready

vérifie la présence des polices avec :

document.fonts.check('16px "Chiller"')


échoue explicitement si une police requise n’est pas chargée

5️⃣ Contraintes moteur

Rendu déterministe

Identique local / serveur / CI

Compatible génération :

images

PDF

canvas

Livrables attendus

Code Node.js modulaire :

extraction des polices

réécriture CSS

gestion des assets

Journalisation claire des polices chargées

Aucun data: URI de police dans le rendu final

L’EPUB est déjà décompressé et accessible sur le disque.

Tu peux faire des hypothèses raisonnables sur la structure du projet.